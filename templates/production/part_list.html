{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>Parça Listesi</h2>
    
    {% if user.teammember.team.name == 'assembly' %}
        <div class="alert alert-info">
            Montaj ekibi olarak tüm parçaları görebilirsiniz.
        </div>
    {% endif %}

    <div class="mb-3">
        {% if not user.teammember.team.name == 'assembly' %}
            <a href="{% url 'part_create' %}" class="btn btn-primary">Yeni Parça Üret</a>
        {% endif %}
    </div>

    <table class="table table-striped" id="partsTable">
        <thead>
            <tr>
                <th>Seri No</th>
                <th>UAV Tipi</th>
                <th>Parça Tipi</th>
                <th>Üretim Tarihi</th>
                <th>Üretici</th>
                <th>Durum</th>
                {% if not user.teammember.team.name == 'assembly' %}
                    <th>İşlemler</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        var columns = [
            { data: 'serial_number' },
            { data: 'uav_type' },
            { data: 'type' },
            { data: 'production_date' },
            { data: 'produced_by' },
            { 
                data: 'is_used',
                render: function(data, type, row) {
                    return data ? '<span class="badge bg-success">Kullanıldı</span>' 
                              : '<span class="badge bg-warning">Stokta</span>';
                }
            }
        ];

        {% if not user.teammember.team.name == 'assembly' %}
            columns.push({
                data: null,
                render: function(data, type, row) {
                    if (!row.is_used) {
                        return '<form method="post" action="/production/parts/' + row.id + '/delete/" style="display: inline;">' +
                               '{% csrf_token %}' +
                               '<button type="submit" class="btn btn-danger btn-sm" onclick="return confirm(\'Bu parçayı geri dönüşüme göndermek istediğinizden emin misiniz?\')">' +
                               '<i class="fas fa-recycle"></i> Geri Dönüşüm</button></form>';
                    }
                    return '';
                }
            });
        {% endif %}

        $('#partsTable').DataTable({
            processing: true,
            serverSide: true,
            ajax: {
                url: '/api/parts/datatable_data/',
                type: 'GET',
                dataSrc: 'data'
            },
            columns: columns,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/tr.json'
            },
            order: [[3, 'desc']]  // Üretim tarihine göre sırala
        });
    });
</script>
{% endblock %}
